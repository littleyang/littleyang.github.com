<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/Blog">
<head>
    <meta charset="UTF-8" />
    <meta name="application-name" content="Looking-Glass" />
    <meta name="author" content="LittleYang" />
    <meta name="generator" content="Jekyll 0.12.0" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />

    <meta itemprop="name" content="You-Get 0.2.1：Vimeo视频的下载">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="" />

    <title>You-Get 0.2.1：Vimeo视频的下载</title>

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" />
    <link rel="icon" type="image/vnd.microsoft.icon" href="/favicon.ico" sizes="57x57" />

    <link rel="author" type="text/html" href="https://plus.google.com/100974147585154622588/about" />
    <link rel="license" type="text/html" href="http://creativecommons.org/licenses/by-sa/3.0/" />

    <!-- Google Web Fonts (not in use) -->
    <!-- link rel='stylesheet' type='text/css' href='http://fonts.googleapis.com/css?family=Droid+Sans' / -->

    <link rel="stylesheet" type="text/css" href="/~css/main.css" media="all" />
    <link rel="stylesheet" type="text/css" href="/~css/mobile.css" media="all and (max-width:1023px)" />

    <!-- Pygments -->
    <link rel="stylesheet" type="text/css" href="/~css/pygments.css" media="all" />

    <!-- Highlight.js -->
    <link rel="stylesheet" href="/~css/tomorrow-night.min.css">
    <script src="/~js/highlight.pack.js"></script>
    <!-- script>hljs.initHighlightingOnLoad();</script -->

    <!-- jQuery & Galleria -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.js"></script>
    <script src="/~plugins/galleria/galleria-1.2.8.min.js"></script>

    <!-- MathJax (not in use) -->
    <!-- script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
        });
    </script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script -->

    <!-- ShareThis (not in use) -->
    <!-- script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
    <script type="text/javascript">stLight.options({publisher: "9aabed9c-ac3f-4f96-8f5a-8e7a27307543"}); </script -->

    <!-- Google Analytics -->
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-27086900-1']);
        _gaq.push(['_setDomainName', '.soimort.org']);
        _gaq.push(['_trackPageview']);
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>

    <script type="text/javascript" src="/~js/main.js"></script>

</head>

<body>
    <!-- load background image (must be put in body) -->
    <script type="text/javascript">
        document.body.style.backgroundImage = "url('http://i.imgur.com/0eQ5v.jpg')";
    </script>

    <nav id="navBarTop">
        <ul class="navBarListLeft">
            <li><a href="/"><img src="/~images/home.png" alt="home" title="Home" class="navDock" height="24" /></a></li>
            <li><a href="/atom.xml" target="_blank"><img src="/~images/feed.png" alt="feed" title="Feed" class="navDock" height="24" /></a></li>
        </ul>

        <ul class="navBarListRight">
            <li style="position: relative; top: -5px"><b>LittleYang</b> on </li>
            <!-- Google+ --><li><a href="https://plus.google.com/107586052733788098083/" target="_blank"><img src="https://ssl.gstatic.com/images/icons/gplus-32.png" alt="gplus" title="Google+" class="navDock" height="24" /></a></li>
            <!-- Twitter --><li><a href="https://twitter.com/soimort" target="_blank"><img src="/~images/twitter.png" alt="twitter" title="Twitter" class="navDock" height="24" /></a></li>
            <!-- Facebook --><!-- li><a href="https://www.facebook.com/soimort" target="_blank"><img src="/~images/facebook.png" alt="facebook" title="Facebook" class="navDock" height="24" /></a></li -->
            <!-- deviantArt --><li><a href="http://soimort.deviantart.com" target="_blank"><img src="/~images/deviantart.png" alt="deviantart" title="deviantART" class="navDock" height="24" /></a></li>
            <!-- GitHub --><li><a href="http://github.com/soimort" target="_blank"><img src="/~images/github.png" alt="github" title="GitHub" class="navDock" height="24" /></a></li>
        </ul>
    </nav>

    <nav id="navBarBottom">
        <div class="navBarListLeft">
            <div style="position: relative; top: 4px; width: 60%">
                © 2013 <a href="http://www.google.com" target="_blank"><b>Little Yang</b></a>. Under the <a href="http://creativecommons.org/licenses/by-sa/3.0/" target="_blank"><b>CC BY-SA 3.0 License</b></a>.
            </div>
        </div>

        <div class="navBarListRight">
            <div style="position: relative; top: 4px; right: 0">
                 |Powered by <a href="http://jekyllrb.com/" target="_blank"><b>Jekyll</b></a>
            </div>
        </div>
    </nav>

    <div id="divTitle">
    <h1>You-Get 0.2.1：Vimeo视频的下载</h1>
    <p><div class="g-plusone" data-size="medium" data-annotation="none"></div></p>
    <p><b>02 Sep 2012</b>, by <b>Mort</b></p>
    <p></p>
    <div id="divTitleNav">
        <a href="/"><img src="/~images/left-arrow.png" class="navDock" /></a>
    </div>
</div>

<div id="divPost">
    <article id="articlePost">
        <p>Python 3的YouTube/优酷视频下载工具<a href="https://github.com/soimort/you-get">You-Get</a>今天更新到0.2.1版了。</p>

<p>新版本特性一览：</p>

<ul>
<li>添加了对<a href="http://vimeo.com">Vimeo</a>的支持。</li>
<li>添加了对youku-lixian所支持的其他所有视频网站的支持：

<ul>
<li>AcFun <a href="http://www.acfun.tv">http://www.acfun.tv</a></li>
<li>bilibili <a href="http://www.bilibili.tv">http://www.bilibili.tv</a></li>
<li>CNTV <a href="http://www.cntv.cn">http://www.cntv.cn</a></li>
<li>爱奇艺 <a href="http://www.iqiyi.com">http://www.iqiyi.com</a></li>
<li>酷6网 <a href="http://www.ku6.com">http://www.ku6.com</a></li>
<li>PPTV <a href="http://www.pptv.com">http://www.pptv.com</a></li>
<li>新浪视频 <a href="http://video.sina.com.cn">http://video.sina.com.cn</a></li>
<li>搜狐视频 <a href="http://tv.sohu.com">http://tv.sohu.com</a></li>
<li>56网 <a href="http://www.56.com">http://www.56.com</a></li>
<li>凤凰视频 <a href="http://v.ifeng.com">http://v.ifeng.com</a></li>
</ul></li>
<li>加上0.0.1版中原有的支持：

<ul>
<li>YouTube <a href="http://www.youtube.com">http://www.youtube.com</a></li>
<li>音悦台 <a href="http://www.yinyuetai.com">http://www.yinyuetai.com</a></li>
<li>优酷 <a href="http://www.youku.com">http://www.youku.com</a></li>
<li>土豆 <a href="http://www.tudou.com">http://www.tudou.com</a></li>
</ul></li>
</ul>

<p>至此，You-Get已经实现了youku-lixian全部功能的同等替代。</p>

<h2><a href="http://pypi.python.org/pypi">芝士商店（Cheeseshop）</a>上架啦！</h2>

<p><a href="http://pypi.python.org/pypi/you-get/">You-Get</a>已经在<a href="http://pypi.python.org/pypi">PyPI（Cheeseshop）</a>上<a href="http://pypi.python.org/pypi/you-get/">注册</a>。以后可以直接通过<a href="http://www.pip-installer.org/">Pip</a>或者<a href="http://pypi.python.org/pypi/setuptools">EasyInstall</a>来进行安装和升级：</p>
<div class="highlight"><pre><code class="text">$ pip install you-get

$ you-get
</code></pre></div>
<p>或：</p>
<div class="highlight"><pre><code class="text">$ easy_install you-get

$ you-get
</code></pre></div>
<p>你仍然可以通过从Git获取源码的方式来使用You-Get：</p>
<div class="highlight"><pre><code class="text">$ git clone git://github.com/soimort/you-get.git

$ cd you-get/
$ ./you-get
</code></pre></div>
<p>通过以下命令将You-Get安装到系统路径（与Pip安装等效）：</p>
<div class="highlight"><pre><code class="text">$ make install

$ you-get
</code></pre></div>
<h2>命令行的使用</h2>

<p>请参考<a href="https://github.com/soimort/you-get/blob/master/README.md#you-get---%E4%B8%AD%E6%96%87%E8%AF%B4%E6%98%8E">中文说明</a>。</p>

<h2>Python APIs的使用</h2>

<p>这里有一个<a href="https://github.com/soimort/you-get/blob/master/README.md#examples-for-developers">简单的示例</a>。</p>

<h2>技术细节：Vimeo视频的下载 / HTTP headers的正确伪造方法（误）</h2>

<p>简略地介绍一下如何使用Python 3下载Vimeo视频的实现细节，感兴趣的可以看。</p>

<p>Vimeo的视频地址格式主要有类似如下两种（以任意视频为例）：</p>

<p><a href="http://vimeo.com/48070853">http://vimeo.com/48070853</a></p>

<p><a href="http://vimeo.com/channels/staffpicks/48070853">http://vimeo.com/channels/staffpicks/48070853</a></p>

<p>无论哪种URL，最后的一串数字就是Vimeo视频的ID。用一行正则表达式匹配获取这个ID（令视频地址为变量<code>url</code>）：</p>
<div class="highlight"><pre><code class="text">id = re.search(r&#39;http://\w*vimeo.com[/\w]*/(\d+)$&#39;, url).group(1)
</code></pre></div>
<p>在相应的HTML页面中（令HTML内容存放于变量<code>html</code>），我们需要抓取三个重要的JSON信息：</p>
<div class="highlight"><pre><code class="text">signature = re.search(r&#39;&quot;signature&quot;:&quot;([^&quot;]+)&quot;&#39;, html).group(1)
timestamp = re.search(r&#39;&quot;timestamp&quot;:([^,]+)&#39;, html).group(1)
title = re.search(r&#39;&quot;title&quot;:&quot;([^&quot;]+)&quot;&#39;, html).group(1)
</code></pre></div>
<p><code>title</code>即为视频的标题。其他两个变量值<code>signature</code>和<code>timestamp</code>用来和<code>id</code>一同构成视频的真实地址：</p>
<div class="highlight"><pre><code class="text">url = &#39;http://player.vimeo.com/play_redirect?clip_id=%s&amp;sig=%s&amp;time=%s&#39; \
% (id, signature, timestamp)
</code></pre></div>
<p>我在这里得到的<code>signature</code>是<code>80e1d7a8ee1e7fecce971566cbe94a09</code>，<code>timestamp</code>是<code>1346545369</code>，加上视频的<code>id</code>：<code>48070853</code>，合成的<code>url</code>是：</p>

<p><a href="http://player.vimeo.com/play_redirect?clip_id=48070853&amp;sig=80e1d7a8ee1e7fecce971566cbe94a09&amp;time=1346545369">http://player.vimeo.com/play_redirect?clip_id=48070853&amp;sig=80e1d7a8ee1e7fecce971566cbe94a09&amp;time=1346545369</a></p>

<p>但是，这个地址根本就是无效的（既无法用Python进行下一步请求，也不能在浏览器中打开）。原因是，我们直接使用了Python默认的request header来获取HTML内容，而Vimeo采取的下载防范措施禁止我们这么做。所以，直接通过这种方式抓取的视频URL被封禁掉了：</p>

<p><img src="http://i.imgur.com/znGur.png" width="100%" /></p>

<p>解决的方法也很简单。子曰：使用伪造headers的人是邪恶的。现在我们就来用这种邪恶的手段抓取Vimeo上的视频地址，让服务器误以为我们的客户端是正常的浏览器，而不是某个不怀好意的Python脚本。</p>

<p>先找到浏览器所使用的request headers：</p>

<p><img src="http://i.imgur.com/ya6BS.png" width="100%" /></p>

<p>将其原封不动地照搬到Python里：</p>
<div class="highlight"><pre><code class="text">fake_headers = {
    &#39;Accept&#39;: &#39;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&#39;,
    &#39;Accept-Charset&#39;: &#39;UTF-8,*;q=0.5&#39;,
    &#39;Accept-Encoding&#39;: &#39;gzip,deflate,sdch&#39;,
    &#39;Accept-Language&#39;: &#39;en-US,en;q=0.8&#39;,
    &#39;User-Agent&#39;: &#39;Mozilla/5.0 (X11; Linux x86_64) \
AppleWebKit/537.1 (KHTML, like Gecko) Chrome/21.0.1180.57 Safari/537.1&#39;
}
</code></pre></div>
<p>在以后凡是向Vimeo发出HTTP请求时，我们只需发送这个假的<code>fake_headers</code>就好了：</p>
<div class="highlight"><pre><code class="text">response = request.urlopen(request.Request(url, headers = fake_headers), None)
</code></pre></div>
<p>Vimeo是我目前见到的唯一一个会根据浏览器的headers来封锁下载的网站。不过如你所见，对于真心想下载视频的人来说，这招基本上没用。。。</p>

<p><a href="https://github.com/soimort/you-get"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png" alt="Fork me on GitHub"></a></p>

    </article>
    
    
    <article id="articlePost" style="padding-bottom: 0">
        <div id="divDisqus">
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                var disqus_shortname = 'soimort';
                
                var disqus_url = 'http://www.soimort.org/tech-blog/2012/09/02/you-get.html';
                
                
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
    </article>
    
</div>


</body>
</html>
